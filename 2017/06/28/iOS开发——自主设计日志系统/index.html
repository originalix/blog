<!DOCTYPE html><html lang=""><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS开发——自主设计日志系统 | Originalee的博客</title><meta name="description" content="iOS开发——自主设计日志系统 - Originalee"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/casual.css"><link rel="stylesheet" href="/css/semantic.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Originalee的博客"></head><body><div class="sidebar"><div class="ui vertical inverted menu"><div class="h100"></div><h3 class="ui inverted aligned icon header"><div class="content"><a href="/" class="title-link">ORIGINALEE的博客</a></div></h3><div class="h50"></div><div class="side-nav"><a href="/" target="_self" class="item">HOME<i class="icon home"></i></a><a href="/archives" target="_self" class="item">ARCHIVE<i class="icon archive"></i></a><a href="/about" target="_self" class="item">INFO<i class="icon info"></i></a><a href="/atom.xml" target="_self" class="item">RSS<i class="icon rss"></i></a></div><div class="item"><div class="ui inverted transparent icon input"><input type="text" placeholder="Search..." class="st-default-search-input"><i class="search icon"></i></div></div><div class="h50"></div></div><div class="h50 mq"><a class="ui teal big label"><i class="content icon"></i></a></div><div class="author-info"><a href="/" class="img-link"><img src="/avatar.png" class="author-photo ui tiny circular image"></a><h4 class="ui aligned icon header"><div class="content">Originalee</div></h4><p class="author-desc">爱打篮球的程序员|目前移动端爬坑中</p><div class="social-outer"><div class="social-inner"><a href="https://github.com/originalix" target="_blank" class="social-link"><i class="icon github"></i></a><a href="mailto:xiao.liunit@gmail.com" target="_self" class="social-link"><i class="icon mail"></i></a></div></div></div></div><div class="main"><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS开发——自主设计日志系统</h1><div class="post-info"><div class="post-date"><h6 class="ui header"><i class="calendar icon"></i><div class="content">Jun 28, 2017</div></h6></div></div><div class="post-content"><p>好像很久没有写有关iOS的文章了，其实iOS的开发一直都是在进行的，但是最近有需求拓宽知识的宽度，所以一直在接触别的知识，当然啦，移动端开发并不能丢下。</p>
<p>我平时开发的项目监测bug和崩溃的模块都是集成了鹅厂的<code>Bugly</code>系统，毕竟是谁用谁说好的第三方系统。而<code>Bugly</code>主要还是返回的还是崩溃之后的日志，所以如果想在平时的运行中，就能拿到客户手机中的日志怎么办呢。在这个需求的驱使下，便开始着手设计一个日志系统。</p>
<p>需求还是不难的，记录手机操作的内容，如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">时间|日志级别|类名_函数名_行数|分类|Log内容</div></pre></td></tr></table></figure>
<p>这样的一种日志形式。</p>
<p>因为不希望频繁的读写，所以希望每十条Log生成之后，读写一次。而未写入硬盘的Log保存在内存中。按照天数，每天都有一份日志，并且在客户的手机异常之后，可以将所有日志压缩上传到服务器。需求介绍完了，并不难对不对。</p>
<a id="more"></a>
<p>在Log的生成方面，我的设计是枚举出日志的级别，之后利用Swift的 <code>#function</code> 和 <code>#line</code>等定义，方便的获取函数名和行数，类名我是利用一个对于<code>NSObject</code>的<code>extension</code>来完成的，类似这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> className: <span class="type">String</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: type(of: <span class="keyword">self</span>)).components(separatedBy: <span class="string">"."</span>).last!</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">var</span> <span class="title">className</span>: <span class="title">String</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: <span class="keyword">self</span>).components(separatedBy: <span class="string">"."</span>).last!</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>开箱可用，准确获取类名。</p>
<p>生成log的核心函数例如如下这样：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">createLog</span><span class="params">(level: DebugLevel, targetClass: AnyClass, type: OperateType, content: String,  <span class="number">_</span> line: Int = #line, <span class="number">_</span> function: String = #function)</span></span></div><div class="line">-&gt; <span class="type">String</span> &#123;</div><div class="line">    <span class="keyword">let</span> lineStr = <span class="type">String</span>.<span class="keyword">init</span>(format: <span class="string">"line:%d"</span>, line)</div><div class="line">    <span class="keyword">let</span> levelStr = levelToString(level: level)</div><div class="line">    <span class="keyword">let</span> separator = <span class="string">"|"</span></div><div class="line">    <span class="keyword">let</span> classSeparator = <span class="string">"_"</span></div><div class="line">    <span class="keyword">let</span> log: <span class="type">String</span> = <span class="type">Date</span>().<span class="built_in">toString</span>() + separator + levelStr + separator + targetClass.className + classSeparator + function + classSeparator + lineStr + separator + content + <span class="string">"\n"</span></div><div class="line">    <span class="built_in">print</span>(log)</div><div class="line">    <span class="keyword">return</span> log</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而基于这个函数做一些封装，就能封装出很简便的打印各级别日志的API了。</p>
<p>至此，介绍完Log的生成类： <code>LogGenerator</code>。</p>
<p>之后是对日志的读写，需要有一个文件读写的类，暂定名为<code>LogStorage</code>。</p>
<p>因为文件的读写都是常规的操作，所以代码就不贴出来了。我在这里只是贴出我在<code>LogStorage</code>类里暴露的接口方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">LogStorageProtocol</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/// 获取日志缓存地址</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Returns: String</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getCachePath</span><span class="params">()</span></span> -&gt; <span class="type">String</span></div><div class="line"></div><div class="line">    <span class="comment">/// 删除文件</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Parameter fileName: String</span></div><div class="line">    <span class="comment">/// - Returns: Bool</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">deleteFile</span><span class="params">(fileName: String)</span></span> -&gt; <span class="type">Bool</span></div><div class="line"></div><div class="line">    <span class="comment">/// 清除全部日志缓存</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Returns: Bool</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">cleanCache</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></div><div class="line"></div><div class="line">    <span class="comment">/// 读取日志文件</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Parameter fileName: String</span></div><div class="line">    <span class="comment">/// - Returns: Data</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">readFile</span><span class="params">(fileName: String)</span></span> -&gt; <span class="type">Data</span>?</div><div class="line"></div><div class="line">    <span class="comment">/// 更新写入Log数据</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Parameters:</span></div><div class="line">    <span class="comment">///   - fileName: String</span></div><div class="line">    <span class="comment">///   - data: Data</span></div><div class="line">    <span class="comment">/// - Returns: Data</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">updateFile</span><span class="params">(fileName: String, data: Data)</span></span> -&gt; <span class="type">Bool</span></div><div class="line"></div><div class="line">    <span class="comment">/// 自动根据天数创建文件名</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Returns: String</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createFileName</span><span class="params">()</span></span> -&gt; <span class="type">String</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而这个十条一写，没有达到标准的就暂时保存在内存里，我的想法是创建一个循环队列，根据FIFO原则，当满足十条Log时，做一次写入操作，而循环队列在空间上是非常节省资源的，如果没有满足十条日志，那就都暂存在队列里，整个开销就是循环队列的一个数组，容量是11个元素，还有一个充当哨兵。</p>
<p>循环队列的数据结构是队列的数据结构里最基础的</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">QueueProtocol</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createQueue</span><span class="params">()</span></span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">traverseQueue</span><span class="params">()</span></span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isFullQueue</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">isEmptyQueue</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">Enqueue</span><span class="params">(log: String)</span></span> -&gt; <span class="type">Bool</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">Dequeue</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在内部增加了一个遍历队列写入日志的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">private func updateFileWhenTranverse() &#123;</div><div class="line">    var i = queue.front</div><div class="line">    while (i != queue.rear) &#123;</div><div class="line">        let fileName = LogStorage.share.createFileName()</div><div class="line">        let data = queue.logData[i].data(using: .utf8)</div><div class="line">        if (LogStorage.share.updateFile(fileName: fileName, data: data!)) &#123;</div><div class="line">            let _ = Dequeue()</div><div class="line">        &#125;</div><div class="line">        i += 1</div><div class="line">        i = i % queue.maxsize</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而最后一个需求就是压缩上传了，在这里使用了<code>SSZipArchive</code>这个第三方库来压缩文件成zip格式。封装成<code>LogArchive</code>类。是不是三言两语间，整个日志系统就设计完成了，但是我是用<code>Swift</code>来写的，若是<code>Objective-C</code>调用怎么办呢。答案当然是用Objc强大的宏定义来搞定咯，几个宏定义，轻松的一行代码就调用了Log输出。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#define Cute_Debug(log) [[LogGenerator new] debugWithTargetClass:self.classForCoder content:[NSString stringWithFormat:@<span class="meta-string">"%@"</span>, log] :(NSInteger)__LINE__ :[NSString stringWithFormat:@<span class="meta-string">"%s"</span>, __FUNCTION__]];</span></div><div class="line"></div><div class="line"><span class="meta">#define Cute_Warning(log) [[LogGenerator new] warningWithTargetClass:self.classForCoder content:[NSString stringWithFormat:@<span class="meta-string">"%@"</span>, log] :(NSInteger)__LINE__ :[NSString stringWithFormat:@<span class="meta-string">"%s"</span>, __FUNCTION__]];</span></div><div class="line"></div><div class="line"><span class="meta">#define Cute_Info(log) [[LogGenerator new] infoWithTargetClass:self.classForCoder content:[NSString stringWithFormat:@<span class="meta-string">"%@"</span>, log] :(NSInteger)__LINE__ :[NSString stringWithFormat:@<span class="meta-string">"%s"</span>, __FUNCTION__]];</span></div><div class="line"></div><div class="line"><span class="meta">#define Cute_Error(log) [[LogGenerator new] errorWithTargetClass:self.classForCoder content:[NSString stringWithFormat:@<span class="meta-string">"%@"</span>, log] :(NSInteger)__LINE__ :[NSString stringWithFormat:@<span class="meta-string">"%s"</span>, __FUNCTION__]];</span></div></pre></td></tr></table></figure>
<p>整个日志系统，我已经开源放在了我的<a href="https://github.com/originalix/CuteLogger" target="_blank" rel="external">github</a>上，具体的代码可以去github上看。<br>欢迎提issue，如果有用，请点个star谢谢。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/06/21/Linux的用户管理(二)/" class="next"><button class="ui button teal">NEXT</button></a></div><div data-thread-key="2017/06/28/iOS开发——自主设计日志系统/" data-title="iOS开发——自主设计日志系统" data-url="http://yoursite.com/2017/06/28/iOS开发——自主设计日志系统/" class="ds-share"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><span class="ds-more">分享到：</span></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul></div></div><div data-thread-key="2017/06/28/iOS开发——自主设计日志系统/" data-title="iOS开发——自主设计日志系统" data-url="http://yoursite.com/2017/06/28/iOS开发——自主设计日志系统/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"originalee"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">Originalee</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and theme by <a href="https://github.com/littlewin-wang/hexo-theme-casual" target="_blank">casual</a></p></div></footer></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script><script src="/js/jquery.goup.min.js"></script><script src="/js/semantic.min.js"></script><script src="/js/casual.js"></script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>$(document).ready(function(){$.goup({trigger:100,bottomOffset:100,locationOffset:5,title:'',titleAsText:true});});</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','TvAnFS4AVxjiJUvrZJRB','2.0.0');</script></div></body></html>