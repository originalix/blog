---
layout: post
title: Vue3 æºç è§£æï¼ˆå…­ï¼‰ï¼šå“åº”å¼åŸç†ä¸ reactive
categories: [å‰ç«¯, Vue]
description: å¸¦ä½ è§£è¯» Vue3 æºç ï¼Œå“åº”å¼åŸç†ï¼Œreactive
keywords: Vue3, Vueæºç , å“åº”å¼åŸç†, reactive



---

ä»Šå¤©è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ä¼šå¸¦ç€å¤§å®¶ä¸€èµ·æ·±å…¥å‰–æ Vue3 çš„å“åº”å¼åŸç†å®ç°ï¼Œä»¥åŠåœ¨å“åº”å¼åŸºç¡€ API ä¸­çš„ reactive æ˜¯å¦‚ä½•å®ç°çš„ã€‚å¯¹äº Vue æ¡†æ¶æ¥è¯´ï¼Œå…¶éä¾µå…¥çš„å“åº”å¼ç³»ç»Ÿæ˜¯æœ€ç‹¬ç‰¹çš„ç‰¹æ€§ä¹‹ä¸€äº†ï¼Œæ‰€ä»¥ä¸è®ºä»»ä½•ä¸€ä¸ªç‰ˆæœ¬çš„ Vueï¼Œåœ¨ç†Ÿæ‚‰å…¶åŸºç¡€ç”¨æ³•åï¼Œå“åº”å¼åŸç†éƒ½æ˜¯æˆ‘æœ€æƒ³ä¼˜å…ˆäº†è§£çš„éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯é˜…è¯»æºç æ—¶å¿…ç»†ç»†ç ”ç©¶çš„éƒ¨åˆ†ã€‚æ¯•ç«ŸçŸ¥å·±çŸ¥å½¼ç™¾æˆ˜ä¸æ®†ï¼Œå½“ä½ ä½¿ç”¨ Vue æ—¶ï¼ŒæŒæ¡äº†å“åº”å¼åŸç†ä¸€å®šä¼šè®©ä½ çš„ coding è¿‡ç¨‹æ›´åŠ æ¸¸åˆƒæœ‰ä½™çš„ã€‚

## Vue2 çš„å“åº”å¼åŸç†

åœ¨å¼€å§‹ä»‹ç» Vue3 çš„å“åº”å¼åŸç†å‰ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·å›é¡¾ä¸€ä¸‹ Vue2 çš„å“åº”å¼åŸç†ã€‚

å½“æˆ‘ä»¬æŠŠä¸€ä¸ªæ™®é€šé€‰é¡¹ä¼ å…¥ Vue å®ä¾‹çš„ data é€‰é¡¹ä¸­ï¼ŒVue å°†éå†æ­¤å¯¹è±¡æ‰€æœ‰çš„ propertyï¼Œå¹¶ä½¿ç”¨ Object.defineProperty æŠŠè¿™äº› property å…¨éƒ¨è½¬ä¸º getter/setterã€‚è€Œ Vue2 åœ¨å¤„ç†æ•°ç»„æ—¶ï¼Œä¹Ÿä¼šé€šè¿‡åŸå‹é“¾åŠ«æŒä¼šæ”¹å˜æ•°ç»„å†…å…ƒç´ çš„æ–¹æ³•ï¼Œå¹¶åœ¨åŸå‹é“¾è§‚å¯Ÿæ–°å¢çš„å…ƒç´ ï¼Œä»¥åŠæ´¾å‘æ›´æ–°é€šçŸ¥ã€‚

![vue2-observer](https://cn.vuejs.org/images/data.png)

è¿™é‡Œæ”¾ä¸Šä¸€å¼  Vue2 æ–‡æ¡£ä¸­ä»‹ç»å“åº”å¼çš„å›¾ç‰‡ã€‚å¯¹äºæ–‡æ¡£ä¸­æœ‰çš„æè¿°æˆ‘å°±ä¸å†èµ˜è¿°ï¼Œè€Œä» Vue2 çš„æºç è§’åº¦æ¥å¯¹ç…§å›¾ç‰‡è¯´ä¸€è¯´ã€‚åœ¨ Vue2 çš„æºç ä¸­çš„ src/core è·¯å¾„ä¸‹æœ‰ä¸€ä¸ª observer æ¨¡å—ï¼Œå®ƒå°±æ˜¯ Vue2 ä¸­å¤„ç†å“åº”å¼çš„åœ°æ–¹äº†ã€‚åœ¨è¿™ä¸ªæ¨¡å—ä¸‹ observer è´Ÿè´£å°†å¯¹è±¡ã€æ•°ç»„è½¬æ¢æˆå“åº”å¼çš„ï¼Œå³å›¾ä¸­çš„ç´«è‰²éƒ¨åˆ†ï¼Œå¤„ç† Data çš„ getter åŠ setterã€‚å½“ data ä¸­çš„é€‰é¡¹è¢«è®¿é—®æ—¶ï¼Œä¼šè§¦å‘ getterï¼Œæ­¤æ—¶ observer ç›®å½•ä¸‹çš„ wather.js  æ¨¡å—å°±ä¼šå¼€å§‹å·¥ä½œï¼Œå®ƒçš„ä»»åŠ¡å°±æ˜¯æ”¶é›†ä¾èµ–ï¼Œæˆ‘ä»¬æ”¶é›†åˆ°çš„ä¾èµ–æ˜¯ä¸€ä¸ªä¸ª Dep ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ã€‚è€Œ data ä¸­çš„é€‰é¡¹å˜æ›´æ—¶ï¼Œä¼šè§¦å‘ setter çš„è°ƒç”¨ï¼Œè€Œåœ¨ setter çš„è¿‡ç¨‹ä¸­ï¼Œè§¦å‘ dep çš„ notify å‡½æ•°ï¼Œæ´¾å‘æ›´æ–°äº‹ä»¶ï¼Œç”±æ­¤å®ç°æ•°æ®çš„å“åº”ç›‘å¬ã€‚

## Vue3 çš„å“åº”å¼å˜åŒ–

åœ¨ç®€å•å›é¡¾äº† Vue2 çš„å“åº”å¼åŸç†åï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼ŒVue3 çš„å“åº”å¼åŸç†ä¸ Vue2 ç›¸æ¯”æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

åœ¨ Vue3 ä¸­å“åº”å¼ç³»ç»Ÿæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ï¼Œæ•°æ®æ¨¡å‹æ˜¯è¢«ä»£ç†çš„ JavaScript å¯¹è±¡äº†ã€‚ä¸è®ºæ˜¯æˆ‘ä»¬åœ¨ç»„ä»¶çš„ data é€‰é¡¹ä¸­è¿”å›ä¸€ä¸ªæ™®é€šçš„JavaScript å¯¹è±¡ï¼Œè¿˜æ˜¯ä½¿ç”¨ composition api åˆ›å»ºä¸€ä¸ª reactive å¯¹è±¡ï¼ŒVue3 éƒ½ä¼šå°†è¯¥å¯¹è±¡åŒ…è£¹åœ¨ä¸€ä¸ªå¸¦æœ‰ get å’Œ set å¤„ç†ç¨‹åºçš„ Proxy ä¸­ã€‚

Proxy å¯¹è±¡ç”¨äºåˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†ï¼Œä»è€Œå®ç°åŸºæœ¬æ“ä½œçš„æ‹¦æˆªå’Œè‡ªå®šä¹‰ï¼ˆå¦‚å±æ€§æŸ¥æ‰¾ã€èµ‹å€¼ç­‰ï¼‰ã€‚

å…¶åŸºç¡€è¯­æ³•ç±»ä¼¼äº:

```js
const p = new Proxy(target, handler)
```

Proxy ç›¸æ¯”è¾ƒäº Object.defineProperty ç©¶ç«Ÿæœ‰ä»€ä¹ˆä¼˜åŠ¿å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜è®©æˆ‘ä»¬å…ˆä» Object.defineProperty çš„å¼Šç«¯è¯´èµ·ã€‚

ä» Object çš„è§’åº¦æ¥è¯´ï¼Œç”±äº Object.defineProperty æ˜¯å¯¹æŒ‡å®šçš„ key ç”Ÿæˆ getter/setter ä»¥è¿›è¡Œå˜åŒ–è¿½è¸ªï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ª key ä¸€å¼€å§‹ä¸å­˜åœ¨æˆ‘ä»¬å®šä¹‰çš„å¯¹è±¡ä¸Šï¼Œå“åº”å¼ç³»ç»Ÿå°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œæ‰€ä»¥åœ¨ Vue2 ä¸­æ— æ³•æ£€æµ‹å¯¹è±¡çš„ property çš„æ·»åŠ æˆ–ç§»é™¤ã€‚è€Œå¯¹äºè¿™ä¸ªç¼ºé™·ï¼ŒVue2 æä¾›äº† `vm.$set` å’Œå…¨å±€çš„ `Vue.set` API è®©æˆ‘ä»¬èƒ½å¤Ÿå‘å¯¹è±¡æ·»åŠ å“åº”å¼çš„ propertyã€‚

ä»æ•°ç»„çš„è§’åº¦æ¥è¯´ï¼Œå½“æˆ‘ä»¬ç›´æ¥åˆ©ç”¨ç´¢å¼•è®¾ç½®ä¸€ä¸ªæ•°ç»„é¡¹æ—¶ï¼Œæˆ–è€…å½“æˆ‘ä»¬ä¿®æ”¹æ•°ç»„é•¿åº¦æ—¶ï¼ŒVue2 çš„å“åº”å¼ç³»ç»Ÿéƒ½ä¸èƒ½ç›‘å¬åˆ°å˜åŒ–ï¼Œè§£å†³çš„æ–¹æ³•ä¹Ÿå¦‚ä¸Šï¼Œä½¿ç”¨ä¸Šé¢æåŠçš„ 2 ä¸ª apiã€‚

è€Œè¿™äº›é—®é¢˜åœ¨ ES6 çš„æ–°ç‰¹æ€§ Proxy é¢å‰é€šé€šéƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼ŒProxy å¯¹è±¡èƒ½å¤Ÿåˆ©ç”¨ handler é™·é˜±åœ¨ getã€set æ—¶æ•è·åˆ°ä»»ä½•å˜åŠ¨ï¼Œä¹Ÿèƒ½ç›‘å¬å¯¹æ•°ç»„ç´¢å¼•çš„æ”¹åŠ¨ä»¥åŠ æ•°ç»„ length çš„æ”¹åŠ¨ã€‚

è€Œä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°çš„æ–¹å¼åœ¨ Vue3 ä¸­ä¹Ÿå˜å¾—ä¸åŒï¼Œåœ¨è¿™é‡Œæˆ‘å…ˆå¿«é€Ÿçš„æ•´ä½“æè¿°ä¸€ä¸‹ï¼šåœ¨ Vue3 ä¸­ï¼Œé€šè¿‡ track çš„å¤„ç†å™¨å‡½æ•°æ¥æ”¶é›†ä¾èµ–ï¼Œé€šè¿‡ trigger çš„å¤„ç†å™¨å‡½æ•°æ¥æ´¾å‘æ›´æ–°ï¼Œæ¯ä¸ªä¾èµ–çš„ä½¿ç”¨éƒ½ä¼šè¢«åŒ…è£¹åˆ°ä¸€ä¸ªå‰¯ä½œç”¨ï¼ˆeffectï¼‰å‡½æ•°ä¸­ï¼Œè€Œæ´¾å‘æ›´æ–°åå°±ä¼šæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œè¿™æ ·ä¾èµ–å¤„çš„å€¼å°±è¢«æ›´æ–°äº†ã€‚

## å“åº”å¼åŸºç¡€ reactive çš„å®ç°

æ—¢ç„¶è¿™æ˜¯ä¸€ä¸ªæºç åˆ†æçš„æ–‡ç« ï¼Œå’±ä»¬è¿˜æ˜¯ä»æºç çš„è§’åº¦æ¥åˆ†æå“åº”å¼ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„ã€‚æ‰€ä»¥æˆ‘ä¼šå…ˆåˆ†æå“åº”å¼åŸºç¡€çš„ API â€”â€” reactive ï¼Œç›¸ä¿¡é€šè¿‡è®²è§£ reactive çš„å®ç°ï¼Œå¤§å®¶ä¼šå¯¹ Proxy æœ‰æ›´æ·±åˆ»çš„è®¤è¯†ã€‚

### reactive

äºŒè¯ä¸è¯´ï¼Œç›´æ¥çœ‹æºç ã€‚ä¸‹é¢æ˜¯ reactive API çš„å‡½æ•°ï¼Œå‡½æ•°çš„å‚æ•°æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡ `createReactiveObject` å‡½æ•°å¤„ç†åï¼Œç›´æ¥è¿”å›ä¸€ä¸ª proxy å¯¹è±¡ã€‚

```ts
export function reactive<T extends object>(target: T): UnwrapNestedRefs<T>
export function reactive(target: object) {
  // å¦‚æœè¯•å›¾å»è§‚å¯Ÿä¸€ä¸ªåªè¯»çš„ä»£ç†å¯¹è±¡ï¼Œä¼šç›´æ¥è¿”å›åªè¯»ç‰ˆæœ¬
  if (target && (target as Target)[ReactiveFlags.IS_READONLY]) {
    return target
  }
  // åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡å¹¶è¿”å›
  return createReactiveObject(
    target,
    false,
    mutableHandlers,
    mutableCollectionHandlers,
    reactiveMap
  )
}
```

åœ¨ç¬¬ä¸‰è¡Œèƒ½çœ‹åˆ°é€šè¿‡åˆ¤æ–­ target ä¸­æ˜¯å¦æœ‰ ReactiveFlags ä¸­çš„ IS_READONLY key ç¡®å®šå¯¹è±¡æ˜¯å¦ä¸ºåªè¯»å¯¹è±¡ã€‚ReactiveFlags æšä¸¾ä¼šåœ¨æºç ä¸­ä¸æ–­çš„ä¸æˆ‘ä»¬è§é¢ï¼Œæ‰€ä»¥æœ‰å¿…è¦æå‰ä»‹ç»ä¸€ä¸‹ ReactiveFlagsï¼š

```ts
export const enum ReactiveFlags {
  SKIP = '__v_skip', // æ˜¯å¦è·³è¿‡å“åº”å¼ è¿”å›åŸå§‹å¯¹è±¡
  IS_REACTIVE = '__v_isReactive', // æ ‡è®°ä¸€ä¸ªå“åº”å¼å¯¹è±¡
  IS_READONLY = '__v_isReadonly', // æ ‡è®°ä¸€ä¸ªåªè¯»å¯¹è±¡
  RAW = '__v_raw' // æ ‡è®°è·å–åŸå§‹å€¼
}
```

åœ¨ ReactiveFlags æšä¸¾ä¸­æœ‰ 4 ä¸ªæšä¸¾å€¼ï¼Œè¿™å››ä¸ªæšä¸¾å€¼çš„å«ä¹‰éƒ½åœ¨æ³¨é‡Šé‡Œã€‚å¯¹äº ReactiveFlags çš„ä½¿ç”¨æ˜¯ä»£ç†å¯¹è±¡å¯¹ handler ä¸­çš„ trap é™·é˜±éå¸¸å¥½çš„åº”ç”¨ï¼Œå¯¹è±¡ä¸­å¹¶ä¸å­˜åœ¨è¿™äº› keyï¼Œè€Œé€šè¿‡ get è®¿é—®è¿™äº› key æ—¶ï¼Œè¿”å›å€¼éƒ½æ˜¯é€šè¿‡ get é™·é˜±çš„å‡½æ•°å†…å¤„ç†çš„ã€‚ä»‹ç»å®Œ ReactiveFlags åæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚

### createReactiveObject

```ts
function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>,
  proxyMap: WeakMap<Target, any>
)
```

å…ˆçœ‹ createReactiveObject å‡½æ•°çš„ç­¾åï¼Œè¯¥å‡½æ•°æ¥å— 5 ä¸ªå‚æ•°:

- targetï¼šç›®æ ‡å¯¹è±¡ï¼Œæƒ³è¦ç”Ÿæˆå“åº”å¼çš„åŸå§‹å¯¹è±¡ã€‚
- isReadonlyï¼šç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ˜¯å¦åªè¯»ã€‚
- baseHandlersï¼šç”Ÿæˆä»£ç†å¯¹è±¡çš„ handler å‚æ•°ã€‚å½“ target ç±»å‹æ˜¯ Array æˆ– Object æ—¶ä½¿ç”¨è¯¥ handlerã€‚
- collectionHandlersï¼šå½“ target ç±»å‹æ˜¯ Mapã€Setã€WeakMapã€WeakSet æ—¶ä½¿ç”¨è¯¥ handlerã€‚
- proxyMapï¼šå­˜å‚¨ç”Ÿæˆä»£ç†å¯¹è±¡åçš„ Map å¯¹è±¡ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ baseHandlers å’Œ collectionHandlers çš„åŒºåˆ«ï¼Œè¿™ä¸¤ä¸ªå‚æ•°ä¼šæ ¹æ® target çš„ç±»å‹è¿›è¡Œåˆ¤æ–­ï¼Œæœ€ç»ˆé€‰æ‹©å°†å“ªä¸ªå‚æ•°ä¼ å…¥ Proxy çš„æ„é€ å‡½æ•°ï¼Œå½“åš handler å‚æ•°ä½¿ç”¨ã€‚

æ¥ç€æˆ‘ä»¬å¼€å§‹çœ‹ createReactiveObject çš„é€»è¾‘éƒ¨åˆ†ï¼š

```ts
function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>,
  proxyMap: WeakMap<Target, any>
) {
  // å¦‚æœç›®æ ‡ä¸æ˜¯å¯¹è±¡ï¼Œç›´æ¥è¿”å›åŸå§‹å€¼
  if (!isObject(target)) {
    return target
  }
  // å¦‚æœç›®æ ‡å·²ç»æ˜¯ä¸€ä¸ªä»£ç†ï¼Œç›´æ¥è¿”å›
  // é™¤éå¯¹ä¸€ä¸ªå“åº”å¼å¯¹è±¡æ‰§è¡Œ readonly
  if (
    target[ReactiveFlags.RAW] &&
    !(isReadonly && target[ReactiveFlags.IS_REACTIVE])
  ) {
    return target
  }
  // ç›®æ ‡å·²ç»å­˜åœ¨å¯¹åº”çš„ä»£ç†å¯¹è±¡
  const existingProxy = proxyMap.get(target)
  if (existingProxy) {
    return existingProxy
  }
  // åªæœ‰ç™½åå•é‡Œçš„ç±»å‹æ‰èƒ½è¢«åˆ›å»ºå“åº”å¼å¯¹è±¡
  const targetType = getTargetType(target)
  if (targetType === TargetType.INVALID) {
    return target
  }
  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers
  )
  proxyMap.set(target, proxy)
  return proxy
}
```

åœ¨è¯¥å‡½æ•°çš„é€»è¾‘éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°åŸºç¡€æ•°æ®ç±»å‹å¹¶ä¸ä¼šè¢«è½¬æ¢æˆä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›åŸå§‹å€¼ã€‚

å¹¶ä¸”ä¼šå°†å·²ç»ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ç¼“å­˜è¿›ä¼ å…¥çš„ proxyMapï¼Œå½“è¿™ä¸ªä»£ç†å¯¹è±¡å·²å­˜åœ¨æ—¶ä¸ä¼šé‡å¤ç”Ÿæˆï¼Œä¼šç›´æ¥è¿”å›å·²æœ‰å¯¹è±¡ã€‚

ä¹Ÿä¼šé€šè¿‡ TargetType æ¥åˆ¤æ–­ target ç›®æ ‡å¯¹è±¡çš„ç±»å‹ï¼ŒVue3 ä»…ä¼šå¯¹ Arrayã€Objectã€Mapã€Setã€WeakMapã€WeakSet ç”Ÿæˆä»£ç†ï¼Œå…¶ä»–å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸º INVALIDï¼Œå¹¶è¿”å›åŸå§‹å€¼ã€‚

å½“ç›®æ ‡å¯¹è±¡é€šè¿‡ç±»å‹æ ¡éªŒåï¼Œä¼šé€šè¿‡ new Proxy() ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ proxyï¼Œhandler å‚æ•°çš„ä¼ å…¥ä¹Ÿæ˜¯ä¸ targetType ç›¸å…³ï¼Œå¹¶æœ€ç»ˆè¿”å›å·²ç”Ÿæˆçš„ proxy å¯¹è±¡ã€‚

æ‰€ä»¥å›é¡¾ reactive apiï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½åªæ˜¯è·å¾—ä¼ å…¥çš„ target ç›®æ ‡å¯¹è±¡çš„åŸå§‹å€¼ã€‚

### Handlers çš„ç»„æˆ

åœ¨ @vue/reactive åº“ä¸­æœ‰ baseHandlers å’Œ collectionHandlers ä¸¤ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«ç”Ÿæˆ Proxy ä»£ç†çš„ handlers ä¸­çš„ trap é™·é˜±ã€‚

 ä¾‹å¦‚åœ¨ä¸Šé¢ç”Ÿæˆ reactive çš„ api ä¸­ baseHandlers çš„å‚æ•°ä¼ å…¥äº†ä¸€ä¸ª mutableHandlers å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯è¿™æ ·çš„ï¼š

```ts
export const mutableHandlers: ProxyHandler<object> = {
  get,
  set,
  deleteProperty,
  has,
  ownKeys
}
```

é€šè¿‡å˜é‡åæˆ‘ä»¬èƒ½çŸ¥é“ mutableHandlers ä¸­å­˜åœ¨ 5 ä¸ª trap é™·é˜±ã€‚è€Œåœ¨ baseHandlers ä¸­ï¼Œget å’Œ set éƒ½æ˜¯é€šè¿‡å·¥å‚å‡½æ•°ç”Ÿæˆçš„ï¼Œä»¥ä¾¿äºé€‚é…é™¤ reactive å¤–çš„å…¶ä»– apiï¼Œä¾‹å¦‚ readonlyã€shallowReactiveã€shallowReadonly ç­‰ã€‚

baseHandlers æ˜¯å¤„ç† Arrayã€Object çš„æ•°æ®ç±»å‹çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»å¤§éƒ¨åˆ†æ—¶é—´ä½¿ç”¨ Vue3 æ—¶ä½¿ç”¨çš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘æ¥ä¸‹æ¥ç€é‡çš„è®²ä¸€ä¸‹baseHandlers ä¸­çš„ get å’Œ set é™·é˜±ã€‚

### get é™·é˜±

ä¸Šä¸€æ®µæåˆ° get æ˜¯ç”±ä¸€ä¸ªå·¥å‚å‡½æ•°ç”Ÿæˆçš„ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ get é™·é˜±çš„ç§ç±»ã€‚

```ts
const get = /*#__PURE__*/ createGetter()
const shallowGet = /*#__PURE__*/ createGetter(false, true)
const readonlyGet = /*#__PURE__*/ createGetter(true)
const shallowReadonlyGet = /*#__PURE__*/ createGetter(true, true)
```

get é™·é˜±æœ‰ 4 ä¸ªç±»å‹ï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„å“åº”å¼ APIï¼Œä»åç§°ä¸­å°±å¯ä»¥çŸ¥é“å¯¹åº”çš„ API åç§°ï¼Œéå¸¸ä¸€ç›®äº†ç„¶ã€‚è€Œæ‰€æœ‰çš„ get éƒ½æ˜¯ç”± createGetter å‡½æ•°ç”Ÿæˆçš„ã€‚æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡çœ‹ä¸€ä¸‹ createGetter çš„é€»è¾‘ã€‚

è¿˜æ˜¯è€è§„çŸ©ï¼Œå…ˆä»å‡½æ•°ç­¾åçœ‹èµ·ã€‚

```ts
function createGetter(isReadonly = false, shallow = false) {
  return function get(target: Target, key: string | symbol, receiver: object) {}
}
```

createGetter æœ‰ isReadonly å’Œ shallow ä¸¤ä¸ªå‚æ•°ï¼Œè®©ä½¿ç”¨ get é™·é˜±çš„ api æŒ‰éœ€ä½¿ç”¨ã€‚è€Œå‡½æ•°çš„å†…éƒ¨è¿”å›äº†ä¸€ä¸ª get å‡½æ•°ï¼Œä½¿ç”¨é«˜é˜¶å‡½æ•°çš„æ–¹å¼è¿”å›å°†ä¼šä¼ å…¥ handlers ä¸­ get å‚æ•°çš„å‡½æ•°ã€‚

æ¥ç€çœ‹ createGetter çš„é€»è¾‘ï¼š

```ts
// å¦‚æœ get è®¿é—®çš„ key æ˜¯ '__v_isReactive'ï¼Œè¿”å› createGetter çš„ isReadonly å‚æ•°å–åç»“æœ
if (key === ReactiveFlags.IS_REACTIVE) {
  return !isReadonly
} else if (key === ReactiveFlags.IS_READONLY) {
  // å¦‚æœ get è®¿é—®çš„ key æ˜¯ '__v_isReadonly'ï¼Œè¿”å› createGetter çš„ isReadonly å‚æ•°
  return isReadonly
} else if (
  // å¦‚æœ get è®¿é—®çš„ key æ˜¯ '__v_raw'ï¼Œå¹¶ä¸” receiver ä¸åŸå§‹æ ‡è¯†ç›¸ç­‰ï¼Œåˆ™è¿”å›åŸå§‹å€¼
  key === ReactiveFlags.RAW &&
  receiver ===
    (isReadonly
      ? shallow
        ? shallowReadonlyMap
        : readonlyMap
      : shallow
        ? shallowReactiveMap
        : reactiveMap
    ).get(target)
) {
  return target
}
```

ä»è¿™æ®µ createGetter é€»è¾‘ä¸­ï¼Œæˆ‘ä¸“é—¨ä»‹ç»è¿‡çš„ ReactiveFlags æšä¸¾åœ¨è¿™å°±å–å¾—äº†å¦™ç”¨ã€‚å…¶å®ç›®æ ‡å¯¹è±¡ä¸­å¹¶æ²¡æœ‰è¿™äº› keyï¼Œä½†æ˜¯åœ¨ get ä¸­Vue3 å°±å¯¹è¿™äº› key åšäº†ç‰¹æ®Šå¤„ç†ï¼Œå½“æˆ‘ä»¬åœ¨å¯¹è±¡ä¸Šè®¿é—®è¿™å‡ ä¸ªç‰¹æ®Šçš„æšä¸¾å€¼æ—¶ï¼Œå°±ä¼šè¿”å›ç‰¹å®šæ„ä¹‰çš„ç»“æœã€‚è€Œå¯ä»¥å…³æ³¨ä¸€ä¸‹ ReactiveFlags.IS_REACTIVE è¿™ä¸ª key çš„åˆ¤æ–­æ–¹å¼ï¼Œä¸ºä»€ä¹ˆæ˜¯åªè¯»æ ‡è¯†çš„å–åå‘¢ï¼Ÿå› ä¸ºå½“ä¸€ä¸ªå¯¹è±¡çš„è®¿é—®èƒ½è§¦å‘è¿™ä¸ª get é™·é˜±æ—¶ï¼Œè¯´æ˜è¿™ä¸ªå¯¹è±¡å¿…ç„¶å·²ç»æ˜¯ä¸€ä¸ª Proxy å¯¹è±¡äº†ï¼Œæ‰€ä»¥åªè¦ä¸æ˜¯åªè¯»çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºæ˜¯å“åº”å¼å¯¹è±¡äº†ã€‚

æ¥ç€çœ‹ get çš„åç»­é€»è¾‘ã€‚

ç»§ç»­åˆ¤æ–­ target æ˜¯å¦æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœä»£ç†å¯¹è±¡ä¸æ˜¯åªè¯»çš„ï¼Œå¹¶ä¸” target æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”è®¿é—®çš„ key åœ¨æ•°ç»„éœ€è¦ç‰¹æ®Šå¤„ç†çš„æ–¹æ³•é‡Œï¼Œå°±ä¼šç›´æ¥è°ƒç”¨ç‰¹æ®Šå¤„ç†çš„æ•°ç»„å‡½æ•°æ‰§è¡Œç»“æœï¼Œå¹¶è¿”å›ã€‚

arrayInstrumentations æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡å†…ä¿å­˜äº†è‹¥å¹²ä¸ªè¢«ç‰¹æ®Šå¤„ç†çš„æ•°ç»„æ–¹æ³•ï¼Œå¹¶ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ã€‚

æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ Vue2 ä»¥åŸå‹é“¾çš„æ–¹å¼åŠ«æŒäº†æ•°ç»„ï¼Œè€Œåœ¨è¿™é‡Œä¹Ÿæœ‰ç±»ä¼¼åœ°ä½œç”¨ï¼Œè€Œæ•°ç»„çš„éƒ¨åˆ†æˆ‘ä»¬å‡†å¤‡æ”¾åœ¨åç»­çš„æ–‡ç« ä¸­å†ä»‹ç»ï¼Œä¸‹é¢æ˜¯éœ€è¦ç‰¹æ®Šå¤„ç†çš„æ•°ç»„ã€‚

- å¯¹ç´¢å¼•æ•æ„Ÿçš„æ•°ç»„æ–¹æ³•
  - includesã€indexOfã€lastIndexOf
- ä¼šæ”¹å˜è‡ªèº«é•¿åº¦çš„æ•°ç»„æ–¹æ³•ï¼Œéœ€è¦é¿å… length è¢«ä¾èµ–æ”¶é›†ï¼Œå› ä¸ºè¿™æ ·å¯èƒ½ä¼šé€ æˆå¾ªç¯å¼•ç”¨
  - pushã€popã€shiftã€unshiftã€splice

```ts
// åˆ¤æ–­ taeget æ˜¯å¦æ˜¯æ•°ç»„
const targetIsArray = isArray(target)
// å¦‚æœä¸æ˜¯åªè¯»å¯¹è±¡ï¼Œå¹¶ä¸”ç›®æ ‡å¯¹è±¡æ˜¯ä¸ªæ•°ç»„ï¼Œè®¿é—®çš„ key åˆåœ¨æ•°ç»„éœ€è¦åŠ«æŒçš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨ä¿®æ”¹åçš„æ•°ç»„æ–¹æ³•æ‰§è¡Œ
if (!isReadonly && targetIsArray && hasOwn(arrayInstrumentations, key)) {
  return Reflect.get(arrayInstrumentations, key, receiver)
}

// è·å– Reflect æ‰§è¡Œçš„ get é»˜è®¤ç»“æœ
const res = Reflect.get(target, key, receiver)

// å¦‚æœæ˜¯ key æ˜¯ Symbolï¼Œå¹¶ä¸” key æ˜¯ Symbol å¯¹è±¡ä¸­çš„ Symbol ç±»å‹çš„ key
// æˆ–è€… key æ˜¯ä¸éœ€è¦è¿½è¸ªçš„ key: __proto__,__v_isRef,__isVue
// ç›´æ¥è¿”å› get ç»“æœ
if (isSymbol(key) ? builtInSymbols.has(key) : isNonTrackableKeys(key)) {
  return res
}

// ä¸æ˜¯åªè¯»å¯¹è±¡ï¼Œæ‰§è¡Œ track æ”¶é›†ä¾èµ–
if (!isReadonly) {
  track(target, TrackOpTypes.GET, key)
}

// å¦‚æœæ˜¯ shallow æµ…å±‚å“åº”å¼ï¼Œç›´æ¥è¿”å› get ç»“æœ
if (shallow) {
  return res
}

if (isRef(res)) {
  // å¦‚æœæ˜¯ ref ï¼Œåˆ™è¿”å›è§£åŒ…åçš„å€¼ - å½“ target æ˜¯æ•°ç»„ï¼Œkey æ˜¯ int ç±»å‹æ—¶ï¼Œä¸éœ€è¦è§£åŒ…
  const shouldUnwrap = !targetIsArray || !isIntegerKey(key)
  return shouldUnwrap ? res.value : res
}

if (isObject(res)) {
  // å°†è¿”å›çš„å€¼ä¹Ÿè½¬æ¢æˆä»£ç†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåš isObject çš„æ£€æŸ¥ä»¥é¿å…æ— æ•ˆå€¼è­¦å‘Šã€‚
  // ä¹Ÿéœ€è¦åœ¨è¿™é‡Œæƒ°æ€§è®¿é—®åªè¯»å’Œæ˜Ÿå½±è§†å¯¹è±¡ï¼Œä»¥é¿å…å¾ªç¯ä¾èµ–ã€‚
  return isReadonly ? readonly(res) : reactive(res)
}

// ä¸æ˜¯ object ç±»å‹åˆ™ç›´æ¥è¿”å› get ç»“æœ
return res
```

åœ¨å¤„ç†å®Œæ•°ç»„åï¼Œæˆ‘ä»¬å¯¹ target æ‰§è¡Œ Reflect.get æ–¹æ³•ï¼Œè·å¾—é»˜è®¤è¡Œä¸ºçš„ get è¿”å›å€¼ã€‚

ä¹‹ååˆ¤æ–­ å½“å‰ key æ˜¯å¦æ˜¯ Symbolï¼Œæˆ–è€…æ˜¯å¦æ˜¯ä¸éœ€è¦è¿½è¸ªçš„ keyï¼Œå¦‚æœæ˜¯çš„è¯ç›´æ¥è¿”å› get çš„ç»“æœ resã€‚

ä¸‹é¢ğŸ‘‡å‡ ä¸ª key æ˜¯ä¸éœ€è¦è¢«ä¾èµ–æ”¶é›†æˆ–è€…è¿”å›å“åº”å¼ç»“æœçš„ã€‚

- `__proto__` 
- `_v_isRef`
- `__isVue` 

æ¥ç€åˆ¤æ–­å½“å‰ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯åªè¯»å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯åªè¯»çš„è¯ï¼Œåˆ™è¿è¡Œä¸Šæ–‡æåŠçš„ tarck å¤„ç†å™¨å‡½æ•°æ”¶é›†ä¾èµ–ã€‚

å¦‚æœæ˜¯ shallow çš„æµ…å±‚å“åº”å¼ï¼Œåˆ™ä¸éœ€è¦å°†å†…éƒ¨çš„å±æ€§è½¬æ¢æˆä»£ç†ï¼Œç›´æ¥è¿”å› resã€‚

å¦‚æœ res æ˜¯ä¸€ä¸ª Ref ç±»å‹çš„å¯¹è±¡ï¼Œå°±ä¼šè‡ªåŠ¨è§£åŒ…è¿”å›ï¼Œè¿™é‡Œå°±èƒ½è§£é‡Šå®˜æ–¹æ–‡æ¡£ä¸­æåŠçš„ ref åœ¨ reactive ä¸­ä¼šè‡ªåŠ¨è§£åŒ…çš„ç‰¹æ€§äº†ã€‚è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ target æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œå¹¶ä¸” key æ˜¯ int ç±»å‹æ—¶ï¼Œå³ä½¿ç”¨ç´¢å¼•è®¿é—®æ•°ç»„å…ƒç´ æ—¶ï¼Œä¸ä¼šè¢«è‡ªåŠ¨è§£åŒ…ã€‚

å¦‚æœ res æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šå°†è¯¥å¯¹è±¡è½¬æˆå“åº”å¼çš„ Proxy ä»£ç†å¯¹è±¡è¿”å›ï¼Œå†ç»“åˆæˆ‘ä»¬ä¹‹å‰åˆ†æçš„ç¼“å­˜å·²ç”Ÿæˆçš„ proxy å¯¹è±¡ï¼Œå¯ä»¥çŸ¥é“è¿™é‡Œçš„é€»è¾‘å¹¶ä¸ä¼šé‡å¤ç”Ÿæˆç›¸åŒçš„ resï¼Œä¹Ÿå¯ä»¥ç†è§£æ–‡æ¡£ä¸­æåŠçš„å½“æˆ‘ä»¬è®¿é—® reactive å¯¹è±¡ä¸­çš„ key æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå®ƒä¹Ÿä¼šè‡ªåŠ¨çš„è½¬æ¢æˆå“åº”å¼å¯¹è±¡ï¼Œè€Œä¸”ç”±äºåœ¨æ­¤å¤„ç”Ÿæˆ reactive æˆ–è€… readonly å¯¹è±¡æ˜¯ä¸€ä¸ªå»¶è¿Ÿè¡Œä¸ºï¼Œä¸éœ€è¦åœ¨ç¬¬ä¸€æ—¶é—´å°±éå† reactive ä¼ å…¥çš„å¯¹è±¡ä¸­çš„æ‰€æœ‰ keyï¼Œä¹Ÿå¯¹æ€§èƒ½çš„æå‡æ˜¯ä¸€ä¸ªå¸®åŠ©ã€‚

å½“ res éƒ½ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶æ—¶ï¼Œç›´æ¥è¿”å› res ç»“æœã€‚ä¾‹å¦‚åŸºç¡€æ•°æ®ç±»å‹å°±ä¼šç›´æ¥è¿”å›ç»“æœï¼Œè€Œä¸åšç‰¹æ®Šå¤„ç†ã€‚

è‡³æ­¤ï¼Œget é™·é˜±çš„é€»è¾‘å…¨éƒ¨ç»“æŸäº†ã€‚

### set é™·é˜±

ä¸ createGetter å¯¹åº”ï¼Œset ä¹Ÿæœ‰ä¸€ä¸ª createSetter çš„å·¥å‚å‡½æ•°ï¼Œä¹Ÿæ˜¯é€šè¿‡æŸ¯é‡ŒåŒ–çš„æ–¹å¼è¿”å›ä¸€ä¸ª set å‡½æ•°ã€‚

å‡½æ•°ç­¾åéƒ½å¤§åŒå°å¼‚ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ç›´æ¥å¸¦å¤§å®¶ç›˜é€»è¾‘ã€‚

set çš„å‡½æ•°æ¯”è¾ƒç®€çŸ­ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸€æ¬¡æ€§æŠŠå†™å¥½æ³¨é‡Šçš„ä»£ç æ”¾ä¸Šæ¥ï¼Œå…ˆçœ‹ä»£ç å†è®²é€»è¾‘ã€‚

```ts
function createSetter(shallow = false) {
  return function set(
    target: object,
    key: string | symbol,
    value: unknown,
    receiver: object
  ): boolean {
    let oldValue = (target as any)[key]
    if (!shallow) {
      value = toRaw(value)
      oldValue = toRaw(oldValue)
      // å½“ä¸æ˜¯ shallow æ¨¡å¼æ—¶ï¼Œåˆ¤æ–­æ—§å€¼æ˜¯å¦æ˜¯ Refï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ›´æ–°æ—§å€¼çš„ value
      // å› ä¸º ref æœ‰è‡ªå·±çš„ setter
      if (!isArray(target) && isRef(oldValue) && !isRef(value)) {
        oldValue.value = value
        return true
      }
    } else {
      // shallow æ¨¡å¼ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯¹è±¡æŒ‰åŸæ · set
    }
		
    // åˆ¤æ–­ target ä¸­æ˜¯å¦å­˜åœ¨ key
    const hadKey =
      isArray(target) && isIntegerKey(key)
        ? Number(key) < target.length
        : hasOwn(target, key)
    // Reflect.set è·å–é»˜è®¤è¡Œä¸ºçš„è¿”å›å€¼
    const result = Reflect.set(target, key, value, receiver)
    // å¦‚æœç›®æ ‡æ˜¯åŸå§‹å¯¹è±¡åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œåˆ™ä¸ä¼šè§¦å‘ trigger æ´¾å‘æ›´æ–°
    if (target === toRaw(receiver)) {
      // ä½¿ç”¨ trigger æ´¾å‘æ›´æ–°ï¼Œæ ¹æ® hadKey åŒºåˆ«è°ƒç”¨äº‹ä»¶
      if (!hadKey) {
        trigger(target, TriggerOpTypes.ADD, key, value)
      } else if (hasChanged(value, oldValue)) {
        trigger(target, TriggerOpTypes.SET, key, value, oldValue)
      }
    }
    return result
  }
}
```

åœ¨ set çš„è¿‡ç¨‹ä¸­ä¼šé¦–å…ˆè·å–æ–°æ—§ä¸æ—§å€¼ï¼Œå½“ç›®å‰çš„ä»£ç†å¯¹è±¡ä¸æ˜¯æµ…å±‚æ¯”è¾ƒæ—¶ï¼Œä¼šåˆ¤æ–­æ—§å€¼æ˜¯å¦æ˜¯ä¸€ä¸ª Refï¼Œå¦‚æœæ—§å€¼ä¸æ˜¯æ•°ç»„ä¸”æ˜¯ä¸€ä¸ª refç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ–°å€¼ä¸æ˜¯ ref å¯¹è±¡æ—¶ï¼Œä¼šç›´æ¥ä¿®æ”¹æ—§å€¼çš„ valueã€‚

çœ‹åˆ°è¿™é‡Œå¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆè¦æ›´æ–°æ—§å€¼çš„ valueï¼Ÿå¦‚æœä½ ä½¿ç”¨è¿‡ ref è¿™ä¸ª api å°±ä¼šçŸ¥é“ï¼Œæ¯ä¸ª ref å¯¹è±¡çš„å€¼éƒ½æ˜¯æ”¾åœ¨ value é‡Œçš„ï¼Œè€Œ ref ä¸ reactive çš„å®ç°æ˜¯æœ‰åŒºåˆ«çš„ï¼Œref å…¶å®æ˜¯ä¸€ä¸ª class å®ä¾‹ï¼Œå®ƒçš„ value æœ‰è‡ªå·±çš„ set ï¼Œæ‰€ä»¥å°±ä¸ä¼šåœ¨è¿™é‡Œç»§ç»­è¿›è¡Œ set äº†ã€‚ref çš„éƒ¨åˆ†åœ¨åç»­çš„æ–‡ç« ä¸­ä¼šè¯¦ç»†è®²è§£ã€‚

åœ¨å¤„ç†å®Œ ref ç±»å‹çš„å€¼åï¼Œä¼šå£°æ˜ä¸€ä¸ªå˜é‡ hadKeyï¼Œåˆ¤æ–­å½“å‰è¦ set çš„ key æ˜¯å¦æ˜¯å¯¹è±¡ä¸­å·²æœ‰çš„å±æ€§ã€‚

æ¥ä¸‹æ¥è°ƒç”¨ Reflect.set è·å–é»˜è®¤è¡Œä¸ºçš„ set è¿”å›å€¼ resultã€‚

ç„¶åä¼šå¼€å§‹æ´¾å‘æ›´æ–°çš„è¿‡ç¨‹ï¼Œåœ¨æ´¾å‘æ›´æ–°å‰ï¼Œéœ€è¦ä¿è¯ target å’ŒåŸå§‹çš„ receiver ç›¸ç­‰ï¼Œtarget ä¸èƒ½æ˜¯ä¸€ä¸ªåŸå‹é“¾ä¸Šçš„å±æ€§ã€‚

ä¹‹åå¼€å§‹ä½¿ç”¨ trigger å¤„ç†å™¨å‡½æ•°æ´¾å‘æ›´æ–°ï¼Œå¦‚æœ hadKey ä¸å­˜åœ¨ï¼Œåˆ™æ˜¯ä¸€ä¸ªæ–°å¢å±æ€§ï¼Œé€šè¿‡ TriggerOpTypes.ADD æšä¸¾æ¥æ ‡è®°ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°å¼€ç¯‡åˆ†æ Proxy å¼ºäº Object.defineProperty çš„åœ°æ–¹ï¼Œä¼šç›‘æµ‹åˆ°ä»»ä½•ä¸€ä¸ªæ–°å¢çš„ keyï¼Œè®©å“åº”å¼ç³»ç»Ÿæ›´å¼ºå¤§ã€‚

å¦‚æœ key æ˜¯å½“å‰ target ä¸Šå·²ç»å­˜åœ¨çš„å±æ€§ï¼Œåˆ™æ¯”è¾ƒä¸€ä¸‹æ–°æ—§å€¼ï¼Œå¦‚æœæ–°æ—§å€¼ä¸ä¸€æ ·ï¼Œåˆ™ä»£è¡¨å±æ€§è¢«æ›´æ–°ï¼Œé€šè¿‡ TriggerOpTypes.SET æ¥æ ‡è®°æ´¾å‘æ›´æ–°ã€‚

åœ¨æ›´æ–°æ´¾å‘å®Œåï¼Œè¿”å› set çš„ç»“æœ resultï¼Œè‡³æ­¤ set ç»“æŸã€‚

## æ€»ç»“

åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘å…ˆå¸¦å¤§å®¶å›é¡¾äº† Vue2 çš„å“åº”å¼åŸç†ï¼Œåˆå¼€å§‹ä»‹ç» Vue3 çš„å“åº”å¼åŸç†ï¼Œé€šè¿‡æ¯”è¾ƒ Vue2 å’Œ Vue3 çš„å“åº”å¼ç³»ç»Ÿçš„åŒºåˆ«å¼•å‡º Vue3 å“åº”å¼ç³»ç»Ÿçš„æå‡ä¹‹å¤„ï¼Œå°¤å…¶æ˜¯å…¶ä¸­æœ€ä¸»è¦çš„è°ƒæ•´å°† Object.defineProperty æ›¿æ¢ä¸º Proxy ä»£ç†å¯¹è±¡ã€‚

ä¸ºäº†è®©å¤§å®¶å±æ€§ Proxy å¯¹å“åº”å¼ç³»ç»Ÿçš„å½±å“ï¼Œæœ¬æ–‡ç€é‡ä»‹ç»äº†å“åº”å¼åŸºç¡€ APIï¼šreactiveã€‚åˆ†æäº† reactive çš„å®ç°ï¼Œä»¥åŠ reactive api è¿”å›çš„ proxy ä»£ç†å¯¹è±¡ä½¿ç”¨çš„ handlers é™·é˜±ã€‚å¹¶ä¸”å¯¹é™·é˜±ä¸­æˆ‘ä»¬æœ€å¸¸ç”¨çš„ get å’Œ set çš„æºç è¿›è¡Œåˆ†æï¼Œç›¸ä¿¡å¤§å®¶åœ¨çœ‹å®Œæœ¬ç¯‡æ–‡ç« ä»¥åï¼Œå¯¹ proxy è¿™ä¸ª ES2015 çš„æ–°ç‰¹æ€§çš„ä½¿ç”¨åˆæœ‰äº†æ–°çš„ç†è§£ã€‚

æœ¬æ–‡åªæ˜¯ä»‹ç» Vue3 å“åº”å¼ç³»ç»Ÿçš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæ‰€ä»¥ track æ”¶é›†ä¾èµ–ï¼Œtrigger æ´¾å‘æ›´æ–°çš„è¿‡ç¨‹æ²¡æœ‰è¯¦ç»†å±•å¼€ï¼Œåœ¨åç»­çš„æ–‡ç« ä¸­è®¡åˆ’è¯¦ç»†è®²è§£å‰¯ä½œç”¨å‡½æ•° effectï¼Œä»¥åŠ track å’Œ trigger çš„è¿‡ç¨‹ï¼Œå¦‚æœå¸Œæœ›èƒ½è¯¦ç»†äº†è§£å“åº”å¼ç³»ç»Ÿçš„æºç ï¼Œéº»çƒ¦å¤§å®¶ç‚¹ä¸ªå…³æ³¨å…å¾—è¿·è·¯ã€‚

å¦‚æœè¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©åˆ°ä½ äº†è§£ Vue3 ä¸­çš„å“åº”å¼åŸç†å’Œ reactive çš„å®ç°ï¼Œå¸Œæœ›èƒ½ç»™æœ¬æ–‡ç‚¹ä¸€ä¸ªå–œæ¬¢â¤ï¸ã€‚å¦‚æœæƒ³ç»§ç»­è¿½è¸ªåç»­æ–‡ç« ï¼Œä¹Ÿå¯ä»¥å…³æ³¨æˆ‘çš„è´¦å·ï¼Œå†æ¬¡è°¢è°¢èƒ½é˜…è¯»è‡³æ­¤çš„ä½ ã€‚
